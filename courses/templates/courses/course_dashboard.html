{% extends "base.html" %}
{% block title %}{{ course.title }}{% endblock %}
{% block content %}

<div style="max-width:900px;margin:auto;">

<!-- ================================================= -->
<!-- HEADER -->
<!-- ================================================= -->
<div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:12px;">

  <div>
    <h2 style="margin:0;">{{ course.title }}</h2>

    {% if course.overview %}
      <p style="color:#6b7280;margin-top:6px;">
        {{ course.overview }}
      </p>
    {% endif %}
  </div>

  <!-- ================= ACTIONS ================= -->
  <div style="display:flex;gap:8px;flex-wrap:wrap;">

    {% if next_lesson %}
      <a class="btn btn-primary"
         href="{% url 'courses:lesson_detail' course.id next_lesson.id %}">
        â–¶ Continue
      </a>
    {% endif %}

    {% if user.is_staff %}

      <a class="btn btn-secondary"
         href="{% url 'courses:course_edit' course.id %}">
        âœ Edit Course
      </a>

      <a class="btn btn-secondary"
         href="{% url 'courses:chapter_create' course.id %}">
        â• Add Chapter
      </a>

      <a class="btn btn-secondary"
         href="{% url 'courses:lesson_create' course.id %}">
        â• Add Lesson
      </a>

      <form method="post"
            action="{% url 'courses:course_delete' course.id %}"
            style="display:inline;">
        {% csrf_token %}
        <button class="btn btn-secondary"
                onclick="return confirm('Delete course and all lessons?')">
          ğŸ—‘ Delete
        </button>
      </form>

    {% endif %}

  </div>
</div>

<hr>

<!-- ================================================= -->
<!-- PROGRESS BAR -->
<!-- ================================================= -->
<div style="height:10px;background:#e5e7eb;border-radius:6px;">
  <div style="
      height:10px;
      width:{{ progress.percent }}%;
      background:#2563eb;">
  </div>
</div>

<p style="margin-top:10px;">
  <strong>{{ progress.done }}</strong> /
  <strong>{{ progress.total }}</strong>
  lessons completed
  ({{ progress.percent }}%)
</p>

<hr>

<h3>Lessons</h3>

<!-- ================================================= -->
<!-- CHAPTER LOOP -->
<!-- ================================================= -->
{% for chapter, items in grouped.items %}

<div style="margin-top:16px;">

  <!-- CHAPTER HEADER -->
  <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;">

    <h4>
      ğŸ“Œ {% if chapter %}{{ chapter.title }}{% else %}No Chapter{% endif %}
    </h4>

    {% if user.is_staff and chapter %}
      <a class="btn btn-secondary"
         href="{% url 'courses:chapter_edit' course.id chapter.id %}">
         âœ Edit Chapter
      </a>
    {% endif %}

  </div>

  <!-- ================= LESSONS ================= -->
  {% if items %}

    {% for r in items %}
    <div style="
        display:flex;
        justify-content:space-between;
        padding:10px 0;
        border-bottom:1px solid #eee;
        flex-wrap:wrap;
    ">

      <!-- LESSON TITLE -->
      <div>
        {% if r.done %}âœ…{% else %}â¬œ{% endif %}
        <strong>{{ r.lesson.title }}</strong>
      </div>

      <!-- LESSON ACTIONS -->
      <div style="display:flex;gap:6px;flex-wrap:wrap;">

        <!-- OPEN -->
        <a class="btn btn-secondary"
           href="{% url 'courses:lesson_detail' course.id r.lesson.id %}">
           Open
        </a>

        {% if r.has_quiz %}
        {% if r.quiz_enabled %}
            <a class="btn btn-secondary"
              href="{% url 'courses:lesson_quiz' course.id r.lesson.id %}">
              ğŸ§  Quiz
            </a>
        {% elif user.is_staff %}
            <a class="btn btn-secondary"
              href="{% url 'courses:lesson_quiz_create' course.id r.lesson.id %}">
              â• Enable Quiz
            </a>
        {% endif %}
        {% elif user.is_staff %}
          <a class="btn btn-secondary"
            href="{% url 'courses:lesson_quiz_create' course.id r.lesson.id %}">
            â• Create Quiz
          </a>
        {% endif %}

        {% if user.is_staff %}
          <a class="btn btn-secondary"
             href="{% url 'courses:lesson_edit' course.id r.lesson.id %}">
             âœ Edit
          </a>
        {% endif %}

      </div>

    </div>
    {% endfor %}

  {% else %}
      <p style="color:#6b7280;">No lessons in this chapter yet.</p>
  {% endif %}

</div>

{% endfor %}

</div>

{% endblock %}
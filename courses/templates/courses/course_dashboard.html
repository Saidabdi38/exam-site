{% extends "base.html" %}
{% block title %}{{ course.title }}{% endblock %}
{% block content %}

<div style="max-width:900px;margin:auto;">

  <!-- HEADER -->
  <div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:12px;align-items:flex-start;">

    <div>
      <h2 style="margin:0;">{{ course.title }}</h2>

      {% if course.overview %}
        <p style="color:#6b7280;margin:6px 0 0;">{{ course.overview }}</p>
      {% endif %}
    </div>

    <!-- ===== COURSE ACTIONS ===== -->
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">

      {% if next_lesson %}
        <a class="btn btn-primary"
           href="{% url 'courses:lesson_detail' course.id next_lesson.id %}">
          ‚ñ∂ Continue
        </a>
      {% endif %}

      {% if user.is_staff %}
        <a class="btn btn-secondary"
           href="{% url 'courses:course_edit' course.id %}">
          ‚úè Edit Course
        </a>

        <!-- ‚úÖ Add Chapter -->
        <a class="btn btn-secondary"
           href="{% url 'courses:chapter_create' course.id %}">
          ‚ûï Add Chapter
        </a>

        <!-- ‚úÖ Add Lesson -->
        <a class="btn btn-secondary"
           href="{% url 'courses:lesson_create' course.id %}">
          ‚ûï Add Lesson
        </a>

        <!-- ‚úÖ Delete Course -->
        <form method="post"
              action="{% url 'courses:course_delete' course.id %}"
              style="margin:0;display:inline;">
          {% csrf_token %}
          <button type="submit"
                  class="btn btn-secondary"
                  onclick="return confirm('Delete this course and ALL its lessons?');">
            üóë Delete Course
          </button>
        </form>
      {% endif %}

    </div>
  </div>

  <hr>

  <!-- PROGRESS -->
  <div style="height:10px;background:#e5e7eb;border-radius:6px;overflow:hidden;">
    <div style="height:10px;width:{{ progress.percent }}%;background:#2563eb;"></div>
  </div>

  <p style="margin:10px 0 0;">
    <strong>{{ progress.done }}</strong> /
    <strong>{{ progress.total }}</strong>
    lessons <span style="color:#6b7280;">({{ progress.percent }}%)</span>
  </p>

  <hr>

  <h3 style="margin-top:0;">Lessons</h3>

  {% if grouped %}
    {# ‚úÖ IMPORTANT: chapter is an object (or None), not a string #}
    {% for chapter, items in grouped.items %}
      <div style="margin-top:14px;">

        <!-- ‚úÖ CHAPTER HEADER + EDIT BUTTON -->
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">

          <h4 style="margin:0 0 8px;">
            üìå {% if chapter %}{{ chapter.title }}{% else %}No Chapter{% endif %}
          </h4>

          {# ‚úÖ Edit Chapter button shows whenever chapter exists #}
          {% if user.is_staff and chapter %}
            <a class="btn btn-secondary"
               href="{% url 'courses:chapter_edit' course.id chapter.id %}">
              ‚úè Edit Chapter
            </a>
          {% endif %}
        </div>

        {% if items %}
          {% for r in items %}
            <div style="
                display:flex;
                justify-content:space-between;
                gap:10px;
                padding:10px 0;
                border-bottom:1px solid #eee;
                flex-wrap:wrap;
            ">
              <div style="min-width:240px;">
                {% if r.done %}‚úÖ{% else %}‚¨ú{% endif %}
                <strong>{{ r.lesson.title }}</strong>
              </div>

              <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center;">
                <a class="btn btn-secondary"
                   href="{% url 'courses:lesson_detail' course.id r.lesson.id %}">
                  Open
                </a>

                {% if r.lesson.quiz %}
                  <a class="btn btn-secondary"
                     href="{% url 'courses:lesson_quiz' course.id r.lesson.id %}">
                    Quiz
                  </a>
                {% endif %}

                {% if user.is_staff %}
                  <a class="btn btn-secondary"
                     href="{% url 'courses:lesson_edit' course.id r.lesson.id %}">
                    ‚úè Edit
                  </a>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        {% else %}
          <p style="color:#6b7280;margin:0 0 10px;">No lessons in this chapter yet.</p>
        {% endif %}

      </div>
    {% endfor %}
  {% else %}
    <p>No lessons available.</p>
  {% endif %}

</div>

{% endblock %}